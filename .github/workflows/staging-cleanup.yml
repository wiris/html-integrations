name: Cleanup Staging

on:
  workflow_dispatch

jobs:
  delete:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_STAGING }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_STAGING }}
          aws-region: eu-west-2

      - name: List all branches in the repository (clean format)
        run: |
          git fetch --all
          git branch -r | grep -v '\->' | sed 's/origin\///' | sed 's/^\s*//' > repo_branches.txt
          echo "Repository branches (formatted):"
          cat repo_branches.txt

      - name: Get branches from S3 bucket
        run: |
          aws s3 cp "s3://wiris-integrations-staging-html/branches" s3_branches.txt
          echo "Branches from S3:"
          cat s3_branches.txt

      - name: Compare branches from S3 and repo, delete missing ones
        run: |
          echo "Checking if branches from S3 exist in the repository..."

          while read branch; do
            if grep -Fxq "$branch" repo_branches.txt; then
              echo "✅ Branch $branch exists in the repo."
            else
              echo "❌ Branch $branch does NOT exist in the repo. Deleting from S3..."
              aws s3 rm "s3://wiris-integrations-staging-html/$branch" --recursive
            fi
          done < s3_branches.txt
          echo "PATATA"
          cat repo_branches.txt

      # - name: Upload updated branches list to S3
      #   run: |
      #     echo "Uploading cleaned repository branches list to S3..."
      #     aws s3 cp "repo_branches.txt" "s3://wiris-integrations-staging-html/branches"
      #     echo "✅ Updated branches file uploaded successfully."

      - name: Compare branches from S3 and repo
        run: |
          echo "Checking if branches from S3 exist in the repository..."

          while read branch; do
            if grep -Fxq "$branch" repo_branches.txt; then
              echo "✅ Branch $branch exists in the repo."
            else
              echo "❌ Branch $branch does NOT exist in the repo."
            fi
          done < s3_branches.txt
